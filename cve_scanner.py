import socket
import nmap
import requests
import ipaddress

from bs4 import BeautifulSoup


HEADER = """\
   _______    ________   _____                                 
  / ____/ |  / / ____/  / ___/_________ _____  ____  ___  _____
 / /    | | / / __/     \__ \/ ___/ __ `/ __ \/ __ \/ _ \/ ___/
/ /___  | |/ / /___    ___/ / /__/ /_/ / / / / / / /  __/ /    
\____/  |___/_____/   /____/\___/\__,_/_/ /_/_/ /_/\___/_/                                                        
    """

OPTIONS = """\
    [1] - Scan common ports 
    [2] - Scan all ports
    [3] - Scan a range of ports 
    """

error_invalid_message = "Error: The following URL | IP has not been found : \n\n"
# def check_cve(version):
#    url = f"https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword={version}"
#    res = requests.get(url)
#    soup = BeautifulSoup(res.text, "html.parser")
#    if "No matching CVE" in soup.text:
#        return None
#    else:
#        cves = [a.text for a in soup.select("td > a")]
#        return cves


def scan_ports(ip):
    nm = nmap.PortScanner()
    nm.scan(ip, arguments="-sS -T4")
    if ip not in nm.all_hosts():
        print(error_invalid_message + ip)
        scanner()
        return
    open_ports = []
    for port in nm[ip]['tcp']:
        if nm[ip]['tcp'][port]['state'] == 'open':
            open_ports.append(port)
    return open_ports


def url_to_ip(ip):
    try:
        ip = ipaddress.ip_address(ip)
        return str(ip)
    except ValueError:
        try:
            ip = socket.gethostbyname(ip)
            return ip
        except socket.gaierror:
            print(error_invalid_message + ip)
            scanner()
            return None


def scanner():
    ip = url_to_ip(input("Enter the domain name (not the URL) or the IP address to scan: "))
    if not ip:
        return
    ports = scan_ports(ip)
    if ports is None:
        return
    print(f"Open ports on {ip}: {ports}")
    for port in ports:
        return port


def main():
    print(HEADER)
    scanner()


main()
